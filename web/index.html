<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>RAISE Live Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    #map { height: 100vh; }
    .aircraft-label {
      background: white;
      padding: 2px 4px;
      border-radius: 4px;
      font-size: 11px;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const map = L.map('map').setView([48.7, 9.2], 9);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18
    }).addTo(map);

    const aircraftMarkers = {}; //stores aircraft markers
    const aircraftTracks = {};  //stores polylines
    const aircraftTrackPoints = {}; //stores raw lat/lon points
    let selectedAircraft = null;
    let selectedTrackRefreshInterval = null;

    const blueIcon = L.icon({
      iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png',
      iconSize: [24, 24],
      iconAnchor: [12, 12]
    });

    const orangeIcon = L.icon({
      iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png',
      iconSize: [24, 24],
      iconAnchor: [12, 12],
      className: 'selected-icon'
    });

    const style = document.createElement('style');
    style.innerHTML = `.selected-icon img { filter: hue-rotate(45deg) brightness(1.2); }`;
    document.head.appendChild(style);

    async function loadAircrafts() {
      const res = await fetch('http://localhost:8000/aircrafts');
      const aircrafts = await res.json();

      for (const ac of aircrafts) {
        if (!aircraftMarkers[ac.id]) {
          const marker = L.marker([ac.lat, ac.lon], { icon: blueIcon });
          marker.addTo(map).bindTooltip(ac.id, { permanent: true, className: 'aircraft-label', direction: 'top' });
          marker.on('click', () => onSelectAircraft(ac.id));
          aircraftMarkers[ac.id] = marker;
        } else {
          aircraftMarkers[ac.id].setLatLng([ac.lat, ac.lon]);
        }
      }
    }

    async function loadAndUpdateTrack(id) {
      const res = await fetch(`http://localhost:8000/aircrafts/${id}/track`);
      const track = await res.json();
      aircraftTrackPoints[id] = track.map(p => ({ lat: p.lat, lon: p.lon }));
      const cleanTrack = aircraftTrackPoints[id].map(p => [p.lat, p.lon]);

      if (aircraftTracks[id]) {
        aircraftTracks[id].setLatLngs(cleanTrack);
      } else {
        aircraftTracks[id] = L.polyline(cleanTrack, { color: 'blue' }).addTo(map);
      }
    }

    async function onSelectAircraft(id) {
      if (selectedAircraft && aircraftMarkers[selectedAircraft]) {
        aircraftMarkers[selectedAircraft].setIcon(blueIcon);
        if (aircraftTracks[selectedAircraft]) {
          map.removeLayer(aircraftTracks[selectedAircraft]);
        }
        if (selectedTrackRefreshInterval) {
          clearInterval(selectedTrackRefreshInterval);
          selectedTrackRefreshInterval = null;
        }
      }

      selectedAircraft = id;
      aircraftMarkers[id].setIcon(orangeIcon);

      await loadAndUpdateTrack(id);

      selectedTrackRefreshInterval = setInterval(() => {
        if (selectedAircraft) {
          loadAndUpdateTrack(selectedAircraft);
        }
      }, 30000); // refresh every 30 seconds
    }

    map.on('click', () => {
      if (selectedAircraft) {
        if (aircraftTracks[selectedAircraft]) {
          map.removeLayer(aircraftTracks[selectedAircraft]);
        }
        if (aircraftMarkers[selectedAircraft]) {
          aircraftMarkers[selectedAircraft].setIcon(blueIcon);
        }
        selectedAircraft = null;
        if (selectedTrackRefreshInterval) {
          clearInterval(selectedTrackRefreshInterval);
          selectedTrackRefreshInterval = null;
        }
      }
    });

    const socket = new WebSocket("ws://localhost:8000/ws");
    socket.onmessage = (event) => {
      const data = JSON.parse(event.data);
      if (data.type === 'positionUpdate') {
        const id = data.aircraftId;
        const lat = data.lat;
        const lon = data.lon;

        if (aircraftMarkers[id]) {
          aircraftMarkers[id].setLatLng([lat, lon]);
        }

        if (selectedAircraft === id) {
          if (!aircraftTrackPoints[id]) aircraftTrackPoints[id] = [];
          aircraftTrackPoints[id].push({ lat: lat, lon: lon });

          const latlngs = aircraftTrackPoints[id].map(p => [p.lat, p.lon]);
          if (aircraftTracks[id]) {
            aircraftTracks[id].setLatLngs(latlngs);
          } else {
            aircraftTracks[id] = L.polyline(latlngs, { color: 'blue' }).addTo(map);
          }
        }
      }
    };

    loadAircrafts();
    setInterval(loadAircrafts, 5000);
  </script>
</body>
</html>
